---
- name: OpenStack Instance Self-Healing Playbook
  hosts: all
  gather_facts: no
  connection: local

  tasks:
    - name: Initial SSH Check
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
        state: started
      register: ssh_check
      ignore_errors: yes

    # --- SOFT REBOOT PHASE ---
    - name: Attempt Soft Reboots (Max 2)
      openstack.cloud.server_action:
        server: "{{ inventory_hostname }}"
        action: reboot_soft
      register: soft_reboot_result
      # Only run if the initial check failed
      when: ssh_check.failed
      # Retry logic:
      until: "soft_reboot_result is success"
      retries: 1  # 1 retry + 1 initial attempt = 2 total
      delay: 30   # Wait 30s between attempts

    - name: Re-verify SSH after Soft Reboot attempts
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 15
        state: started
      register: post_soft_check
      when: ssh_check.failed
      ignore_errors: yes

    # --- HARD REBOOT PHASE ---
    - name: Attempt Hard Reboot (Last Resort)
      block:
        - name: Trigger Hard Reboot
          openstack.cloud.server_action:
            server: "{{ inventory_hostname }}"
            action: reboot_hard

        - name: Wait 30s for hardware cycle
          ansible.builtin.pause:
            seconds: 30

        - name: Final SSH Verification
          ansible.builtin.wait_for:
            host: "{{ ansible_host }}"
            port: 22
            timeout: 30
            state: started
          register: final_recheck
          ignore_errors: yes
      # Only run if initial AND soft reboots failed
      when: 
        - ssh_check.failed
        - post_soft_check.failed

    # --- FINAL VERDICT ---
    - name: Fail if unreachable after all attempts
      ansible.builtin.fail:
        msg: "CRITICAL: {{ inventory_hostname }} is still down after recovery cycle."
      when: 
        - ssh_check.failed
        - (post_soft_check.failed | default(false))
        - (final_recheck.failed | default(true))