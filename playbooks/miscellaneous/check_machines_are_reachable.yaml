---
- name: OpenStack Instance Self-Healing Playbook
  hosts: all
  gather_facts: no
  connection: local

  tasks:
    - name: Initial SSH Check
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
        state: started
      register: ssh_check
      ignore_errors: yes

    - name: Set initial recovery status
      ansible.builtin.set_fact:
        is_reachable: "{{ not ssh_check.failed }}"

    # --- SOFT REBOOT PHASE ---
    - name: Attempt Soft Reboots (Max 2)
      block:
        - name: Trigger Soft Reboot
          openstack.cloud.server_action:
            action: reboot_soft
            server: "{{ inventory_hostname }}"
          
        - name: Wait 30s for reboot to initiate
          ansible.builtin.pause:
            seconds: 30

        - name: Verify SSH after Soft Reboot
          ansible.builtin.wait_for:
            host: "{{ ansible_host }}"
            port: 22
            timeout: 15
          register: soft_recheck
          ignore_errors: yes

        - name: Update status after Soft Reboot
          ansible.builtin.set_fact:
            is_reachable: "{{ not soft_recheck.failed }}"

      # This loop runs twice but stops immediately if is_reachable becomes true
      when: not is_reachable
      loop: [1, 2]
      loop_control:
        pause: 1 

    # --- HARD REBOOT PHASE ---
    - name: Attempt Hard Reboot (Last Resort)
      block:
        - name: Trigger Hard Reboot
          openstack.cloud.server_action:
            action: reboot_hard
            server: "{{ inventory_hostname }}"

        - name: Wait 30s for hardware cycle
          ansible.builtin.pause:
            seconds: 30

        - name: Final SSH Verification
          ansible.builtin.wait_for:
            host: "{{ ansible_host }}"
            port: 22
            timeout: 30
          register: final_recheck
          ignore_errors: yes

        - name: Update status after Hard Reboot
          ansible.builtin.set_fact:
            is_reachable: "{{ not final_recheck.failed }}"

      when: not is_reachable

    # --- FINAL VERDICT ---
    - name: Fail if unreachable after all attempts
      ansible.builtin.fail:
        msg: "CRITICAL: {{ inventory_hostname }} is still down after 2 soft and 1 hard reboot."
      when: not is_reachable